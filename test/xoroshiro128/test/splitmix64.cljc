(ns xoroshiro128.test.splitmix64
 (:require
  xoroshiro128.long-int
  [xoroshiro128.core :as x]
  [clojure.test :refer [deftest is]]))

(deftest ??seed-extraction
 ; Splitmix64
 (let [gen-one (x/splitmix64 (xoroshiro128.long-int/native-rand))
       gen-one' (-> gen-one x/next x/next x/next)
       a (first (x/seed gen-one'))
       gen-two (x/splitmix64 a)]
  (is
   (.equals
    (-> gen-two x/next x/value)
    (-> gen-one' x/next x/value)))
  (is
   (.equals
    (-> gen-two x/next x/next x/value)
    (-> gen-one' x/next x/next x/value)))))

(deftest ??splitmix64
  []
  (let [next-seed #(xoroshiro128.long-int/+
                    (xoroshiro128.long-int/long %)
                    xoroshiro128.constants/L-0x9E3779B97F4A7C15)
        iterator #(map x/value (iterate x/next (x/splitmix64 (xoroshiro128.long-int/long %))))
        longs-equal? (fn [s-1 s-2]
                      (doall
                       (map
                        #(is (.equals %1 %2))
                        (map xoroshiro128.long-int/long s-1)
                        (map xoroshiro128.long-int/long s-2))))]
    ; Just outlining a list of known-good values.
    (is
     (.equals
      (xoroshiro128.long-int/long "-2152535657050944081")
      (x/value (x/splitmix64 0))))

    (is
     (.equals
      (xoroshiro128.long-int/long "7960286522194355700")
      (x/value (x/splitmix64 (next-seed 0)))))
    (is
     (.equals
      (x/value (x/splitmix64 (next-seed 0)))
      (x/value (x/next (x/splitmix64 0)))))

    (longs-equal?
     (take 10 (iterator 0))
     ["-2152535657050944081"
      "7960286522194355700"
      "487617019471545679"
      "-537132696929009172"
      "1961750202426094747"
      "6038094601263162090"
      "3207296026000306913"
      "-4214222208109204676"
      "4532161160992623299"
      "-884877559730491226"])

    (is
     (.equals
      (xoroshiro128.long-int/long "-7995527694508729151")
      (x/value (x/splitmix64 1))))

    (is
     (.equals
      (xoroshiro128.long-int/long "-4689498862643123097")
      (x/value (x/splitmix64 (next-seed 1)))))

    (is
     (.equals
      (x/value (x/splitmix64 (next-seed 1)))
      (x/value (x/next (x/splitmix64 1)))))

    (longs-equal?
     ["-7995527694508729151"
      "-4689498862643123097"
      "-534904783426661026"
      "8196980753821780235"
      "8195237237126968761"
      "-4373826470845021568"
      "-2262517385565684571"
      "-8797857673641491083"
      "5266705631892356520"
      "-3800091893662914666"]
     (take 10 (iterator 1)))

    (is
     (.equals
      (xoroshiro128.long-int/long "-549842748227632346")
      (x/value (x/splitmix64 "4693323816697189744"))))

    (is
     (.equals
      (xoroshiro128.long-int/long "1984452702661322627")
      (x/value (xoroshiro128.core/splitmix64 "5165464252035433577"))))

    (is
     (.equals
      (xoroshiro128.long-int/long "8603550955848928026")
      (x/value (xoroshiro128.core/splitmix64 "-3762096910555017800"))))

    (is
     (.equals
      (xoroshiro128.long-int/long "2259666501077083692")
      (x/value (xoroshiro128.core/splitmix64 "3265627685425294603"))))

    ; References generated by https://ideone.com/PuauK5 using the C reference implementation.
    (longs-equal?
     ["-1034691706609893923"
      "8680904332693978080"
      "612224539874700810"
      "1493023403444147697"
      "-4971950877442337366"
      "4658924989491456893"
      "-8241183556360570177"
      "3339891364704115287"
      "1891745321218875292"
      "7882050595557362670"
      "-9127375162604566388"
      "-3569741190262511653"
      "4346649363269677585"
      "1348791259155216957"
      "-3755241545019354078"
      "-8372197932075677063"
      "1005476421853585512"
      "4863487860399772318"
      "-8076540459081623095"
      "-5848806425627354111"]
     (take 20 (iterator "8713631545574875647")))

    (longs-equal?
     ["-4244452510388952855"
      "5956223441727670834"
      "-5213410896474884335"
      "-8606047647151789358"
      "-1962840546543243000"
      "4806123284274150721"
      "-452391144067255625"
      "-8128949576161005705"
      "-7766982720124747874"
      "2442572333995175370"
      "8795907375291054885"
      "-8300047804671076982"
      "-947267881210448127"
      "-5039450819200293977"
      "712308302981280290"
      "7522540599929537755"
      "6355174942928525052"
      "5978894557897017932"
      "1384107261312862605"
      "-919695367079934955"]
     (take 20 (iterator "-1652281797047415913")))

    (longs-equal?
     ["8087921443129252442"
      "855057127608676726"
      "-6259317645692393728"
      "8635608728090513967"
      "421061866719506586"
      "1877777419215953186"
      "4368703655494729211"
      "-1556609034609545752"
      "2341270030079493298"
      "-4138133028227527398"
      "-2247435238311012618"
      "-3224698691004407592"
      "2088590171456458876"
      "-1298671274262257903"
      "1782832499389687398"
      "1761783612743519830"
      "-7698279181887729364"
      "7145871122668955989"
      "6134502485225506850"
      "-4145396449423903700"]
     (take 20 (iterator "-8225000251231588461")))

    (longs-equal?
     ["2670967931508222055"
      "-3000391555947838935"
      "8699201354616398215"
      "4677786568774967471"
      "-4447483319296117254"
      "-1295230923362471383"
      "8295783462537564258"
      "2598289853101382717"
      "6806078238418048467"
      "-3643098847711341461"
      "850647228885797518"
      "4470415377057051519"
      "6061701817095049662"
      "-1125420228581506965"
      "-8343796135060713483"
      "-8709337688951741385"
      "-6473846124213406975"
      "4547348900786126390"
      "1842410324700671551"
      "-5605188000391847805"]
     (take 20 (iterator "1208660907874351407")))

    (longs-equal?
     ["-2485330961573533924"
      "2003845614284201340"
      "8537714462879617001"
      "475936958727069082"
      "-3649477943072457787"
      "6767009688717836876"
      "-101939472702990911"
      "-5839602631113212659"
      "-6522866584845456357"
      "-7197524940719392529"
      "3174802993620206951"
      "-8589839196322619404"
      "5020282923123977254"
      "-5832226764092013228"
      "1465530971980567248"
      "-8980745324321520516"
      "8794186555272603565"
      "2088909702140509611"
      "-5077844290574236237"
      "-9009488735979577267"]
     (take 20 (iterator "-7753703826340145833")))))
